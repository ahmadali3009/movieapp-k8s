name: Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      ec2_host:
        description: 'EC2 host IP or hostname'
        required: false
        default: '16.16.89.200'
      ec2_user:
        description: 'EC2 SSH user (e.g., ec2-user, ubuntu)'
        required: true
        default: 'ec2-user'

env:
  DOCKER_USERNAME: ahmedbutt3009
  BACKEND_IMAGE: movieapp-backend
  FRONTEND_IMAGE: movieapp-frontend
  EC2_ELASTIC_IP: 16.16.89.200

jobs:
  deploy-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          # Write key and normalize line endings
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          sed -i 's/\r$//' ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Verify key format
          ssh-keygen -l -f ~/.ssh/deploy_key || (echo "‚ö†Ô∏è  SSH key format issue - checking first line:" && head -1 ~/.ssh/deploy_key)
          ssh-keyscan -H ${{ github.event.inputs.ec2_host }} >> ~/.ssh/known_hosts

      - name: Create deployment script
        run: |
          cat > deploy-ec2.sh << 'EOF'
          #!/bin/bash
          set -e
          
          DOCKER_USERNAME="${{ env.DOCKER_USERNAME }}"
          BACKEND_IMAGE="${{ env.BACKEND_IMAGE }}"
          FRONTEND_IMAGE="${{ env.FRONTEND_IMAGE }}"
          IMAGE_TAG="latest"
          
          echo "üê≥ Pulling latest Docker images..."
          docker pull ${DOCKER_USERNAME}/${BACKEND_IMAGE}:${IMAGE_TAG}
          docker pull ${DOCKER_USERNAME}/${FRONTEND_IMAGE}:${IMAGE_TAG}
          
          echo "üõë Stopping existing containers..."
          docker stop movieapp-backend movieapp-frontend 2>/dev/null || true
          docker rm movieapp-backend movieapp-frontend 2>/dev/null || true
          
          echo "üöÄ Starting backend container..."
          docker run -d \
            --name movieapp-backend \
            --restart unless-stopped \
            -p 5000:5000 \
            -e MONGODB_URI="${{ secrets.MONGODB_URI }}" \
            -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            -e NODE_ENV="${{ secrets.NODE_ENV }}" \
            -e PORT=5000 \
            ${DOCKER_USERNAME}/${BACKEND_IMAGE}:${IMAGE_TAG}
          
          echo "üöÄ Starting frontend container..."
          docker run -d \
            --name movieapp-frontend \
            --restart unless-stopped \
            -p 80:80 \
            -e API_URL="${{ secrets.API_URL }}" \
            -e APP_ENV="${{ secrets.APP_ENV }}" \
            ${DOCKER_USERNAME}/${FRONTEND_IMAGE}:${IMAGE_TAG}
          
          echo "‚úÖ Deployment complete!"
          echo "üìä Container status:"
          docker ps | grep movieapp
          
          echo "üßπ Cleaning up old images..."
          docker image prune -f
          EOF
          chmod +x deploy-ec2.sh

      - name: Copy deployment script to EC2
        run: |
          scp -i ~/.ssh/deploy_key deploy-ec2.sh ${{ github.event.inputs.ec2_user }}@${{ github.event.inputs.ec2_host }}:/tmp/

      - name: Copy docker-compose file (optional)
        run: |
          scp -i ~/.ssh/deploy_key docker-compose.yml ${{ github.event.inputs.ec2_user }}@${{ github.event.inputs.ec2_host }}:/tmp/ || true

      - name: Execute deployment on EC2
        run: |
          ssh -i ~/.ssh/deploy_key ${{ github.event.inputs.ec2_user }}@${{ github.event.inputs.ec2_host }} << 'ENDSSH'
            # Ensure Docker is installed and running
            if ! command -v docker &> /dev/null; then
              echo "Docker is not installed. Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              sudo systemctl start docker
              sudo systemctl enable docker
            fi
            
            # Log in to Docker Hub if needed
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin || true
            
            # Run deployment script
            bash /tmp/deploy-ec2.sh
            
            # Health check
            echo "üè• Performing health checks..."
            sleep 10
            curl -f http://localhost:5000/api/health || echo "Backend health check failed"
            curl -f http://localhost:80 || echo "Frontend health check failed"
          ENDSSH

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ github.event.inputs.ec2_user }}@${{ github.event.inputs.ec2_host }} << 'ENDSSH'
            echo "üìä Container Status:"
            docker ps --filter "name=movieapp"
            echo ""
            echo "üìù Recent logs (backend):"
            docker logs --tail 20 movieapp-backend || true
            echo ""
            echo "üìù Recent logs (frontend):"
            docker logs --tail 20 movieapp-frontend || true
          ENDSSH

